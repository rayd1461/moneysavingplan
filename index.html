<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>每日30元存錢計畫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .day-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .day-grid {
                grid-template-columns: repeat(10, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <header class="text-center mb-6 sm:mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">每日30元存錢計畫</h1>
            
            <div id="summary" class="text-xl sm:text-2xl font-semibold text-green-600 mb-1">
                總金額：0 元（應存金額：0 元，達成率：0%）
            </div>
            
            <div id="jpy-conversion" class="text-lg font-medium text-gray-600">
                日幣換算：-- JPY（匯率：載入中...）
            </div>
            
        </header>

        <div id="month-buttons" class="flex flex-wrap justify-center gap-2 mb-6">
            </div>

        <div id="all-months">
            </div>
        
        <div id="emergency-fund-section" class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">臨時急用金</h2>
            <div class="flex flex-wrap gap-4 mb-4">
                <button id="withdraw-btn" class="px-6 py-2 bg-red-500 text-white font-semibold rounded-lg shadow hover:bg-red-600 transition-colors duration-200">
                    提領急用金
                </button>
                <button id="repay-btn" class="px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow hover:bg-blue-600 transition-colors duration-200">
                    歸還急用金
                </button>
            </div>
            
            <div id="emergency-fund-summary" class="bg-gray-50 p-4 rounded-lg shadow-inner mb-4">
                <p class="text-lg font-semibold text-gray-700">總提領：<span id="total-withdrawn" class="text-red-500">0</span> 元</p>
                <p class="text-lg font-semibold text-gray-700">總歸還：<span id="total-repaid" class="text-blue-500">0</span> 元</p>
                <p class="text-xl font-bold mt-2">未還金額：<span id="outstanding-amount" class="text-red-700">0</span> 元</p>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">類型</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金額</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="emergency-fund-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="dividend-section" class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">股息發放紀錄</h2>
            
            <form id="dividend-form" class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6 space-y-3">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="stock-id" class="block text-sm font-medium text-gray-700">❶ 股名/股號</label>
                        <input type="text" id="stock-id" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div>
                        <label for="ex-dividend-date" class="block text-sm font-medium text-gray-700">❷ 除息日期</label>
                        <input type="date" id="ex-dividend-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div>
                        <label for="payout-date" class="block text-sm font-medium text-gray-700">❸ 股息發放日期</label>
                        <input type="date" id="payout-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="shares-held" class="block text-sm font-medium text-gray-700">❹ 持有股數</label>
                        <input type="number" id="shares-held" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div>
                        <label for="dividend-per-share" class="block text-sm font-medium text-gray-700">❺ 每股股利 (元)</label>
                        <input type="number" step="0.001" id="dividend-per-share" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition-colors duration-200">
                            紀錄股息
                        </button>
                    </div>
                </div>
            </form>

            <h3 class="text-xl font-bold text-gray-800 mb-2">發放紀錄總覽</h3>
            <div class="overflow-x-auto mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">股名/股號</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">除息日期</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">發放日期</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">持有股數</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">每股股利</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">總股息 (無條件捨去)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="dividend-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-2">已留存股票資訊 (股名/股號 & 每股股利)</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">股名/股號</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最後紀錄股利</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">快速填寫</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="stock-info-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-lg p-6 max-w-sm w-full text-center shadow-2xl">
                <p id="message-text" class="text-lg font-semibold text-gray-800 mb-4"></p>
                <button id="message-ok-btn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">好的</button>
            </div>
        </div>
        
        <div id="input-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-lg p-6 max-w-lg w-full shadow-2xl">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <div class="space-y-4">
                    <div>
                        <label for="input-amount" class="block text-sm font-medium text-gray-700">金額 (元)</label>
                        <input type="number" id="input-amount" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div>
                        <label for="input-date" class="block text-sm font-medium text-gray-700">日期</label>
                        <input type="date" id="input-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div>
                        <label for="input-note" class="block text-sm font-medium text-gray-700">備註 (選填)</label>
                        <input type="text" id="input-note" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">取消</button>
                    <button id="modal-save-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // *** 變數定義 ***
        const startDate = new Date("2025-05-27");
        const endDate = new Date("2026-11-01"); 
        const savingPerDay = 30;

        // 定義 localStorage 儲存鍵值
        const checkedKey = "saving_checked_days";
        const monthlyExtraKey = "saving_monthly_extra";
        const emergencyFundKey = "saving_emergency_fund";
        const dividendKey = "saving_dividend_records";
        const stockInfoKey = "saving_stock_info"; 
        
        // 匯率變數
        let twdToJpyRate = null;
        let totalSavedAmount = 0; // 用於儲存最新的總金額

        // 取得 localStorage 中的資料
        const checkedDays = new Set(JSON.parse(localStorage.getItem(checkedKey)) || []);
        const monthlyExtras = JSON.parse(localStorage.getItem(monthlyExtraKey)) || {};
        const emergencyFundRecords = JSON.parse(localStorage.getItem(emergencyFundKey)) || [];
        const dividendRecords = JSON.parse(localStorage.getItem(dividendKey)) || [];
        const stockInfo = new Map(JSON.parse(localStorage.getItem(stockInfoKey)) || []);

        // 取得 HTML 元素
        const summaryDiv = document.getElementById("summary");
        const jpyConversionDiv = document.getElementById("jpy-conversion"); // 新增：日幣轉換區塊
        const monthButtonsDiv = document.getElementById("month-buttons");
        const allMonthsDiv = document.getElementById("all-months");
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok-btn');
        const inputModal = document.getElementById('input-modal');
        const modalTitle = document.getElementById('modal-title');
        const inputAmount = document.getElementById('input-amount');
        const inputDate = document.getElementById('input-date');
        const inputNote = document.getElementById('input-note');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const repayBtn = document.getElementById('repay-btn');
        const emergencyFundTableBody = document.getElementById('emergency-fund-table-body');
        const totalWithdrawnSpan = document.getElementById('total-withdrawn');
        const totalRepaidSpan = document.getElementById('total-repaid');
        const outstandingAmountSpan = document.getElementById('outstanding-amount');
        const dividendForm = document.getElementById('dividend-form');
        const dividendTableBody = document.getElementById('dividend-table-body');
        const stockInfoTableBody = document.getElementById('stock-info-table-body');

        // 獲取股息表單輸入元素
        const stockIdInput = document.getElementById('stock-id');
        const dividendPerShareInput = document.getElementById('dividend-per-share');

        let currentOpenMonth = null;
        let currentModalAction = ''; // 'withdraw' or 'repay'

        // ... (省略輔助函數)
        
        /**
         * 顯示自定義訊息彈窗。
         * @param {string} message - 要顯示的訊息文字。
         */
        const showMessage = (message) => {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        };

        /**
         * 隱藏自定義訊息彈窗。
         */
        const hideMessage = () => {
            messageBox.classList.remove('flex');
            messageBox.classList.add('hidden');
        };
        messageOkBtn.addEventListener('click', hideMessage);

        /**
         * 顯示輸入彈窗。
         * @param {string} title - 彈窗標題。
         * @param {string} action - 'withdraw' or 'repay'。
         */
        const showInputModal = (title, action) => {
            currentModalAction = action;
            modalTitle.textContent = title;
            inputAmount.value = '';
            inputDate.valueAsDate = new Date(); // 預設為今天
            inputNote.value = '';
            inputModal.classList.remove('hidden');
            inputModal.classList.add('flex');
        };

        /**
         * 隱藏輸入彈窗。
         */
        const hideInputModal = () => {
            inputModal.classList.remove('flex');
            inputModal.classList.add('hidden');
        };
        modalCancelBtn.addEventListener('click', hideInputModal);

        /**
         * 取得日期的 ISO 格式字串（只包含年-月-日）。
         * @param {Date} date - 日期物件。
         * @returns {string} - 年-月-日 字串。
         */
        function getDateKey(date) {
            return date.toISOString().split("T")[0];
        }

        /**
         * 格式化月份鍵值為年-月字串。
         * @param {number} year - 年份。
         * @param {number} month - 月份（0-11）。
         * @returns {string} - 年-月 字串。
         */
        function formatMonthKey(year, month) {
            return `${year}-${(month + 1).toString().padStart(2, "0")}`;
        }

        /**
         * 檢查日期是否在存錢計畫的範圍內。
         * @param {Date} date - 日期物件。
         * @returns {boolean} - 是否在範圍內。
         */
        function isInRange(date) {
            const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            
            return checkDate.getTime() >= start.getTime() && checkDate.getTime() <= end.getTime();
        }


        // *** 匯率相關函數 START ***

        /**
         * 獲取最新的台幣對日幣匯率。
         * * 最終可靠方案：讀取同網域下的 latest_rate.json 靜態檔案。
         */
        async function fetchExchangeRate() {
            // 讀取自己網域下的 JSON 檔案，不會有 CORS 問題
            const JSON_URL = 'latest_rate.json'; 
            
            jpyConversionDiv.innerHTML = `日幣換算：-- JPY（匯率：讀取本地檔案...）`;

            try {
                const response = await fetch(JSON_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data && data.twd_to_jpy) {
                    twdToJpyRate = parseFloat(data.twd_to_jpy);
                    updateJpyConversion(); 
                    console.log(`[Exchange Rate] New TWD/JPY Rate from JSON: ${twdToJpyRate.toFixed(4)}`);
                    
                    // 顯示更新時間
                    jpyConversionDiv.innerHTML += ` (更新於: ${data.last_updated})`;
                    
                    return; // 成功取得並返回
                }
                
                // 如果解析失敗
                console.error('[Exchange Rate] Could not parse JPY rate from JSON data.', data);
                jpyConversionDiv.innerHTML = `日幣換算：-- JPY（匯率：檔案內容錯誤）`;

            } catch (error) {
                console.error('[Exchange Rate] Error fetching exchange rate:', error);
                // 可能是檔案不存在 (初次執行 Actions 前)，或連線失敗
                jpyConversionDiv.innerHTML = `日幣換算：-- JPY（匯率：檔案載入失敗/CORS）`;
            }
        }

        /**
         * 更新日幣轉換的顯示。
         */
        function updateJpyConversion() {
            if (twdToJpyRate !== null) {
                // 匯率相乘，並四捨五入到整數
                const jpyAmount = Math.round(totalSavedAmount * twdToJpyRate);
                
                // 為了美觀，匯率保留 4 位小數，金額使用千分位
                jpyConversionDiv.innerHTML = `
                    日幣換算：<span class="font-bold">${jpyAmount.toLocaleString('en-US')}</span> JPY 
                    （匯率：<span class="font-bold">${twdToJpyRate.toFixed(4)}</span>）
                `;
            } else {
                jpyConversionDiv.innerHTML = `日幣換算：-- JPY（匯率：載入中...）`;
            }
        }

        // *** 匯率相關函數 END ***


        /**
         * 更新頁面上的總結資訊。
         */
        function updateSummary() {
            // 每日存款金額
            const totalDaily = checkedDays.size * savingPerDay;
            // 額外收入
            const totalExtra = Object.values(monthlyExtras).reduce((a, b) => a + Number(b), 0);
            
            // 股息總金額 (無條件捨去後加總)
            const totalDividend = dividendRecords.reduce((sum, r) => sum + r.totalDividend, 0);
            
            let totalDays = 0;
            let d = new Date(startDate);
            const tempEndDate = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            while (d.getFullYear() < tempEndDate.getFullYear() || 
                   (d.getFullYear() === tempEndDate.getFullYear() && d.getMonth() < tempEndDate.getMonth()) ||
                   (d.getFullYear() === tempEndDate.getFullYear() && d.getMonth() === tempEndDate.getMonth() && d.getDate() <= tempEndDate.getDate())) {
                totalDays++;
                d.setDate(d.getDate() + 1);
            }

            const shouldSave = totalDays * savingPerDay;
            
            const totalWithdrawn = emergencyFundRecords.filter(r => r.type === 'withdraw').reduce((sum, r) => sum + r.amount, 0);
            const totalRepaid = emergencyFundRecords.filter(r => r.type === 'repay').reduce((sum, r) => sum + r.amount, 0);
            const outstandingAmount = totalWithdrawn - totalRepaid;

            // 總金額 = 每日存款 + 額外收入 + 總股息 - 未還急用金
            totalSavedAmount = totalDaily + totalExtra + totalDividend - outstandingAmount;
            
            // 達成率只計算「每日存款」與「應存金額」的比例
            const percent = shouldSave > 0 ? ((totalDaily / shouldSave) * 100).toFixed(2) : 0;

            summaryDiv.innerHTML = `
                總金額：<span class="font-bold text-green-600">${totalSavedAmount.toFixed(2)}</span> 元
                （應存金額：<span class="font-bold">${shouldSave}</span> 元，達成率：<span class="font-bold">${percent}</span>%）
            `;
            
            totalWithdrawnSpan.textContent = totalWithdrawn;
            totalRepaidSpan.textContent = totalRepaid;
            outstandingAmountSpan.textContent = outstandingAmount;
            
            renderEmergencyFundRecords();
            renderDividendRecords();
            renderStockInfoList();
            
            // 更新日幣轉換顯示
            updateJpyConversion(); 
        }

        // ... (以下為其他功能函數，為節省篇幅省略程式碼，但內容與前次提交保持一致)
        
        function toggleCheck(dateStr, el) { /* ... */ }
        function createMonthView(year, month) { /* ... */ }
        function createInterface() { /* ... */ }
        function renderEmergencyFundRecords() { /* ... */ }
        window.deleteEmergencyRecord = (index) => { /* ... */ };
        withdrawBtn.addEventListener('click', () => showInputModal('提領急用金', 'withdraw'));
        repayBtn.addEventListener('click', () => showInputModal('歸還急用金', 'repay'));
        modalSaveBtn.addEventListener('click', () => { /* ... */ });
        function renderDividendRecords() { /* ... */ }
        window.deleteDividendRecord = (index) => { /* ... */ };
        window.quickFillDividend = (stockID, dividendPerShare) => { /* ... */ };
        function renderStockInfoList() { /* ... */ }
        window.deleteStockInfo = (stockID) => { /* ... */ };
        dividendForm.addEventListener('submit', (e) => { /* ... */ });


        // *** 初始化與定時器設定 ***

        /**
         * 頁面初始化。
         */
        function initialize() {
            createInterface();
            updateSummary(); // 第一次計算總金額
            fetchExchangeRate(); // 第一次獲取匯率

            // 設定定時器：每 10 分鐘 (10 * 60 * 1000 毫秒) 重新抓取匯率
            setInterval(fetchExchangeRate, 10 * 60 * 1000); 
        }

        initialize();

    </script>
</body>
</html>
