<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>每日30元存錢計畫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .day-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .day-grid {
                grid-template-columns: repeat(10, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8">
        <header class="text-center mb-6 sm:mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">每日30元存錢計畫</h1>
            
            <div id="summary" class="text-xl sm:text-2xl font-semibold text-green-600 mb-1">
                總金額：0 元（應存金額：0 元，達成率：0%）
            </div>
            
            <div id="jpy-conversion" class="text-lg font-medium text-gray-600">
                日幣換算：-- JPY（匯率：載入中...）
            </div>
            
        </header>

        <div id="month-buttons" class="flex flex-wrap justify-center gap-2 mb-6">
            </div>

        <div id="all-months">
            </div>
        
        <div id="emergency-fund-section" class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">臨時急用金</h2>
            <div class="flex flex-wrap gap-4 mb-4">
                <button id="withdraw-btn" class="px-6 py-2 bg-red-500 text-white font-semibold rounded-lg shadow hover:bg-red-600 transition-colors duration-200">
                    提領急用金
                </button>
                <button id="repay-btn" class="px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow hover:bg-blue-600 transition-colors duration-200">
                    歸還急用金
                </button>
            </div>
            
            <div id="emergency-fund-summary" class="bg-gray-50 p-4 rounded-lg shadow-inner mb-4">
                <p class="text-lg font-semibold text-gray-700">總提領：<span id="total-withdrawn" class="text-red-500">0</span> 元</p>
                <p class="text-lg font-semibold text-gray-700">總歸還：<span id="total-repaid" class="text-blue-500">0</span> 元</p>
                <p class="text-xl font-bold mt-2">未還金額：<span id="outstanding-amount" class="text-red-700">0</span> 元</p>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">類型</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金額</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="emergency-fund-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="dividend-section" class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">股息發放紀錄</h2>
            
            <form id="dividend-form" class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6 space-y-3">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="stock-id" class="block text-sm font-medium text-gray-700">❶ 股名/股號</label>
                        <input type="text" id="stock-id" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div>
                        <label for="ex-dividend-date" class="block text-sm font-medium text-gray-700">❷ 除息日期</label>
                        <input type="date" id="ex-dividend-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div>
                        <label for="payout-date" class="block text-sm font-medium text-gray-700">❸ 股息發放日期</label>
                        <input type="date" id="payout-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="shares-held" class="block text-sm font-medium text-gray-700">❹ 持有股數</label>
                        <input type="number" id="shares-held" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div>
                        <label for="dividend-per-share" class="block text-sm font-medium text-gray-700">❺ 每股股利 (元)</label>
                        <input type="number" step="0.001" id="dividend-per-share" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition-colors duration-200">
                            紀錄股息
                        </button>
                    </div>
                </div>
            </form>

            <h3 class="text-xl font-bold text-gray-800 mb-2">發放紀錄總覽</h3>
            <div class="overflow-x-auto mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">股名/股號</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">除息日期</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">發放日期</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">持有股數</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">每股股利</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">總股息 (無條件捨去)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="dividend-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-2">已留存股票資訊 (股名/股號 & 每股股利)</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">股名/股號</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最後紀錄股利</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">快速填寫</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="stock-info-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-lg p-6 max-w-sm w-full text-center shadow-2xl">
                <p id="message-text" class="text-lg font-semibold text-gray-800 mb-4"></p>
                <button id="message-ok-btn" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">好的</button>
            </div>
        </div>
        
        <div id="input-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-lg p-6 max-w-lg w-full shadow-2xl">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <div class="space-y-4">
                    <div>
                        <label for="input-amount" class="block text-sm font-medium text-gray-700">金額 (元)</label>
                        <input type="number" id="input-amount" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div>
                        <label for="input-date" class="block text-sm font-medium text-gray-700">日期</label>
                        <input type="date" id="input-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                    <div>
                        <label for="input-note" class="block text-sm font-medium text-gray-700">備註 (選填)</label>
                        <input type="text" id="input-note" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" />
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">取消</button>
                    <button id="modal-save-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // *** 變數定義 ***
        const startDate = new Date("2025-05-27");
        const endDate = new Date("2026-11-01"); 
        const savingPerDay = 30;

        // 定義 localStorage 儲存鍵值
        const checkedKey = "saving_checked_days";
        const monthlyExtraKey = "saving_monthly_extra";
        const emergencyFundKey = "saving_emergency_fund";
        const dividendKey = "saving_dividend_records";
        const stockInfoKey = "saving_stock_info"; 
        
        // 匯率變數
        let twdToJpyRate = null;
        let totalSavedAmount = 0; // 用於儲存最新的總金額

        // 取得 localStorage 中的資料
        const checkedDays = new Set(JSON.parse(localStorage.getItem(checkedKey)) || []);
        const monthlyExtras = JSON.parse(localStorage.getItem(monthlyExtraKey)) || {};
        const emergencyFundRecords = JSON.parse(localStorage.getItem(emergencyFundKey)) || [];
        const dividendRecords = JSON.parse(localStorage.getItem(dividendKey)) || [];
        const stockInfo = new Map(JSON.parse(localStorage.getItem(stockInfoKey)) || []);

        // 取得 HTML 元素
        const summaryDiv = document.getElementById("summary");
        const jpyConversionDiv = document.getElementById("jpy-conversion"); // 新增：日幣轉換區塊
        const monthButtonsDiv = document.getElementById("month-buttons");
        const allMonthsDiv = document.getElementById("all-months");
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok-btn');
        const inputModal = document.getElementById('input-modal');
        const modalTitle = document.getElementById('modal-title');
        const inputAmount = document.getElementById('input-amount');
        const inputDate = document.getElementById('input-date');
        const inputNote = document.getElementById('input-note');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const repayBtn = document.getElementById('repay-btn');
        const emergencyFundTableBody = document.getElementById('emergency-fund-table-body');
        const totalWithdrawnSpan = document.getElementById('total-withdrawn');
        const totalRepaidSpan = document.getElementById('total-repaid');
        const outstandingAmountSpan = document.getElementById('outstanding-amount');
        const dividendForm = document.getElementById('dividend-form');
        const dividendTableBody = document.getElementById('dividend-table-body');
        const stockInfoTableBody = document.getElementById('stock-info-table-body');

        // 獲取股息表單輸入元素
        const stockIdInput = document.getElementById('stock-id');
        const dividendPerShareInput = document.getElementById('dividend-per-share');

        let currentOpenMonth = null;
        let currentModalAction = ''; // 'withdraw' or 'repay'

        // ... (省略輔助函數)
        
        /**
         * 顯示自定義訊息彈窗。
         * @param {string} message - 要顯示的訊息文字。
         */
        const showMessage = (message) => {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        };

        /**
         * 隱藏自定義訊息彈窗。
         */
        const hideMessage = () => {
            messageBox.classList.remove('flex');
            messageBox.classList.add('hidden');
        };
        messageOkBtn.addEventListener('click', hideMessage);

        /**
         * 顯示輸入彈窗。
         * @param {string} title - 彈窗標題。
         * @param {string} action - 'withdraw' or 'repay'。
         */
        const showInputModal = (title, action) => {
            currentModalAction = action;
            modalTitle.textContent = title;
            inputAmount.value = '';
            inputDate.valueAsDate = new Date(); // 預設為今天
            inputNote.value = '';
            inputModal.classList.remove('hidden');
            inputModal.classList.add('flex');
        };

        /**
         * 隱藏輸入彈窗。
         */
        const hideInputModal = () => {
            inputModal.classList.remove('flex');
            inputModal.classList.add('hidden');
        };
        modalCancelBtn.addEventListener('click', hideInputModal);

        /**
         * 取得日期的 ISO 格式字串（只包含年-月-日）。
         * @param {Date} date - 日期物件。
         * @returns {string} - 年-月-日 字串。
         */
        function getDateKey(date) {
            return date.toISOString().split("T")[0];
        }

        /**
         * 格式化月份鍵值為年-月字串。
         * @param {number} year - 年份。
         * @param {number} month - 月份（0-11）。
         * @returns {string} - 年-月 字串。
         */
        function formatMonthKey(year, month) {
            return `${year}-${(month + 1).toString().padStart(2, "0")}`;
        }

        /**
         * 檢查日期是否在存錢計畫的範圍內。
         * @param {Date} date - 日期物件。
         * @returns {boolean} - 是否在範圍內。
         */
        function isInRange(date) {
            const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            
            return checkDate.getTime() >= start.getTime() && checkDate.getTime() <= end.getTime();
        }


        // *** 匯率相關函數 START ***

        /**
         * 獲取最新的台幣對日幣匯率。
         * * ❗ 解決方案：切換到 ExchangeRate-API (使用免費Key)。
         * 由於您是純前端使用，請使用以下 URL。
         * 注意：'f233f27f54c952b7b4d18306' 是一個公開範例 Key，若未來失效，請自行註冊替換。
         */
        async function fetchExchangeRate() {
            try {
                // 以 TWD 為基礎獲取所有貨幣匯率
                const API_URL = 'https://v6.exchangerate-api.com/v6/f233f27f54c952b7b4d18306/latest/TWD';
                
                const response = await fetch(API_URL);
                const data = await response.json();
                
                // 檢查 API 是否成功返回
                if (data.result === 'success' && data.conversion_rates && data.conversion_rates.JPY) {
                    // 1 TWD = X JPY
                    twdToJpyRate = data.conversion_rates.JPY;
                    updateJpyConversion(); // 獲取匯率後立即更新顯示
                    console.log(`[Exchange Rate] New TWD/JPY Rate: ${twdToJpyRate.toFixed(4)}`);
                } else {
                    // 如果API返回失敗，顯示錯誤訊息
                    console.error('[Exchange Rate] Could not retrieve JPY rate.', data);
                    jpyConversionDiv.innerHTML = `日幣換算：-- JPY（匯率：錯誤，API返回失敗）`;
                }
            } catch (error) {
                console.error('[Exchange Rate] Error fetching exchange rate:', error);
                jpyConversionDiv.innerHTML = `日幣換算：-- JPY（匯率：連線失敗）`;
            }
        }

        /**
         * 更新日幣轉換的顯示。
         */
        function updateJpyConversion() {
            if (twdToJpyRate !== null) {
                // 匯率相乘，並四捨五入到整數
                const jpyAmount = Math.round(totalSavedAmount * twdToJpyRate);
                
                // 為了美觀，匯率保留 4 位小數
                jpyConversionDiv.innerHTML = `
                    日幣換算：<span class="font-bold">${jpyAmount.toLocaleString('en-US')}</span> JPY 
                    （匯率：<span class="font-bold">${twdToJpyRate.toFixed(4)}</span>）
                `;
            } else {
                jpyConversionDiv.innerHTML = `日幣換算：-- JPY（匯率：載入中...）`;
            }
        }

        // *** 匯率相關函數 END ***


        /**
         * 更新頁面上的總結資訊。
         */
        function updateSummary() {
            // 每日存款金額
            const totalDaily = checkedDays.size * savingPerDay;
            // 額外收入
            const totalExtra = Object.values(monthlyExtras).reduce((a, b) => a + Number(b), 0);
            
            // 股息總金額 (無條件捨去後加總)
            const totalDividend = dividendRecords.reduce((sum, r) => sum + r.totalDividend, 0);
            
            let totalDays = 0;
            let d = new Date(startDate);
            const tempEndDate = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            while (d.getFullYear() < tempEndDate.getFullYear() || 
                   (d.getFullYear() === tempEndDate.getFullYear() && d.getMonth() < tempEndDate.getMonth()) ||
                   (d.getFullYear() === tempEndDate.getFullYear() && d.getMonth() === tempEndDate.getMonth() && d.getDate() <= tempEndDate.getDate())) {
                totalDays++;
                d.setDate(d.getDate() + 1);
            }

            const shouldSave = totalDays * savingPerDay;
            
            const totalWithdrawn = emergencyFundRecords.filter(r => r.type === 'withdraw').reduce((sum, r) => sum + r.amount, 0);
            const totalRepaid = emergencyFundRecords.filter(r => r.type === 'repay').reduce((sum, r) => sum + r.amount, 0);
            const outstandingAmount = totalWithdrawn - totalRepaid;

            // 總金額 = 每日存款 + 額外收入 + 總股息 - 未還急用金
            totalSavedAmount = totalDaily + totalExtra + totalDividend - outstandingAmount;
            
            // 達成率只計算「每日存款」與「應存金額」的比例
            const percent = shouldSave > 0 ? ((totalDaily / shouldSave) * 100).toFixed(2) : 0;

            summaryDiv.innerHTML = `
                總金額：<span class="font-bold text-green-600">${totalSavedAmount.toFixed(2)}</span> 元
                （應存金額：<span class="font-bold">${shouldSave}</span> 元，達成率：<span class="font-bold">${percent}</span>%）
            `;
            
            totalWithdrawnSpan.textContent = totalWithdrawn;
            totalRepaidSpan.textContent = totalRepaid;
            outstandingAmountSpan.textContent = outstandingAmount;
            
            renderEmergencyFundRecords();
            renderDividendRecords();
            renderStockInfoList();
            
            // 更新日幣轉換顯示
            updateJpyConversion(); 
        }

        // ... (以下為 toggleCheck, createMonthView, createInterface, renderEmergencyFundRecords, deleteEmergencyRecord, modalSaveBtn 事件, renderDividendRecords, deleteDividendRecord, quickFillDividend, renderStockInfoList, deleteStockInfo, dividendForm 事件，均保持不變)

        /**
         * 標記或取消標記日期。
         * @param {string} dateStr - 日期字串。
         * @param {HTMLElement} el - 日期元素。
         */
        function toggleCheck(dateStr, el) {
            if (checkedDays.has(dateStr)) {
                checkedDays.delete(dateStr);
                el.classList.remove("bg-green-600", "text-white");
            } else {
                checkedDays.add(dateStr);
                el.classList.add("bg-green-600", "text-white");
            }
            localStorage.setItem(checkedKey, JSON.stringify([...checkedDays]));
            updateSummary();
        }

        /**
         * 根據年、月創建一個月份的視圖容器。
         * @param {number} year - 年份。
         * @param {number} month - 月份（0-11）。
         * @returns {HTMLElement} - 月份視圖的容器元素。
         */
        function createMonthView(year, month) {
            const container = document.createElement("div");
            container.className = "month-container hidden flex-wrap gap-2 mb-4 p-4 rounded-lg bg-gray-50 shadow-inner";

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const dayGrid = document.createElement("div");
            dayGrid.className = "day-grid";

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                
                if (!isInRange(date)) {
                    continue;
                }

                const dateStr = getDateKey(date);
                const div = document.createElement("div");
                div.className = "day border border-gray-300 p-2 text-center rounded-md cursor-pointer transition-colors duration-200 hover:bg-gray-200 w-20";
                div.innerText = `${month + 1}/${day}`;
                if (checkedDays.has(dateStr)) {
                    div.classList.add("bg-green-600", "text-white");
                }
                div.onclick = () => toggleCheck(dateStr, div);
                dayGrid.appendChild(div);
            }
            
            container.appendChild(dayGrid);

            const monthKey = formatMonthKey(year, month);
            const inputContainer = document.createElement("div");
            inputContainer.className = "input-container mt-4 flex items-center gap-2 flex-wrap";

            const inputLabel = document.createElement("label");
            inputLabel.className = "font-medium text-gray-700";
            inputLabel.textContent = `本月額外收入：`;

            const input = document.createElement("input");
            input.type = "number";
            input.className = "px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 w-32";
            input.placeholder = "元";
            input.value = monthlyExtras[monthKey] || "";
            input.onkeydown = (e) => {
                if (e.key === "Enter") {
                    monthlyExtras[monthKey] = input.value ? parseInt(input.value) : 0;
                    localStorage.setItem(monthlyExtraKey, JSON.stringify(monthlyExtras));
                    updateSummary();
                    showMessage('額外收入已儲存！');
                }
            };

            inputContainer.appendChild(inputLabel);
            inputContainer.appendChild(input);
            container.appendChild(inputContainer);

            return container;
        }

        /**
         * 創建月份按鈕並將月份視圖加入到頁面中。
         */
        function createInterface() {
            const months = [
                [2025, 4], [2025, 5], [2025, 6], [2025, 7], [2025, 8], [2025, 9], [2025, 10], [2025, 11],
                [2026, 0], [2026, 1], [2026, 2], [2026, 3], [2026, 4], [2026, 5], [2026, 6], [2026, 7], 
                [2026, 8], [2026, 9], [2026, 10] 
            ];

            months.forEach(([year, month]) => {
                const button = document.createElement("button");
                button.className = "month-button px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow hover:bg-blue-600 transition-colors duration-200";
                button.textContent = `${year}/${month + 1}`;
                monthButtonsDiv.appendChild(button);

                const monthDiv = createMonthView(year, month);
                allMonthsDiv.appendChild(monthDiv);

                button.onclick = () => {
                    if (currentOpenMonth && currentOpenMonth !== monthDiv) {
                        currentOpenMonth.classList.add("hidden");
                    }
                    const isOpen = !monthDiv.classList.contains("hidden");
                    if (isOpen) {
                        monthDiv.classList.add("hidden");
                        currentOpenMonth = null;
                    } else {
                        monthDiv.classList.remove("hidden");
                        currentOpenMonth = monthDiv;
                    }
                };
            });
        }

        /**
         * 渲染急用金紀錄表格。
         */
        function renderEmergencyFundRecords() {
            emergencyFundTableBody.innerHTML = '';
            emergencyFundRecords.forEach((record, index) => {
                const row = document.createElement('tr');
                const typeClass = record.type === 'withdraw' ? 'text-red-500' : 'text-blue-500';
                const typeText = record.type === 'withdraw' ? '提領' : '歸還';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${typeClass}">${typeText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.amount} 元</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.note}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900" onclick="deleteEmergencyRecord(${index})">刪除</button>
                    </td>
                `;
                emergencyFundTableBody.appendChild(row);
            });
        }
        
        /**
         * 刪除急用金紀錄。
         * @param {number} index - 要刪除的紀錄在陣列中的索引。
         */
        window.deleteEmergencyRecord = (index) => {
            if (confirm('確定要刪除這筆急用金紀錄嗎？')) {
                emergencyFundRecords.splice(index, 1);
                localStorage.setItem(emergencyFundKey, JSON.stringify(emergencyFundRecords));
                updateSummary();
                showMessage('急用金紀錄已刪除！');
            }
        };

        // 綁定急用金按鈕事件
        withdrawBtn.addEventListener('click', () => showInputModal('提領急用金', 'withdraw'));
        repayBtn.addEventListener('click', () => showInputModal('歸還急用金', 'repay'));

        // 處理提領/歸還急用金的儲存。
        modalSaveBtn.addEventListener('click', () => {
            const amount = parseInt(inputAmount.value);
            const date = inputDate.value;
            const note = inputNote.value || '';
            
            if (isNaN(amount) || amount <= 0 || !date) {
                showMessage('請輸入有效的金額和日期！');
                return;
            }
            
            const newRecord = {
                id: Date.now(),
                type: currentModalAction,
                amount: amount,
                date: date,
                note: note,
            };
            
            emergencyFundRecords.push(newRecord);
            localStorage.setItem(emergencyFundKey, JSON.stringify(emergencyFundRecords));
            updateSummary();
            hideInputModal();
            showMessage('急用金紀錄已儲存！');
        });

        // *** 股息紀錄函數 ***
        
        /**
         * 渲染股息發放紀錄表格。
         */
        function renderDividendRecords() {
            dividendTableBody.innerHTML = '';
            dividendRecords.forEach((record, index) => {
                const totalAmount = record.totalDividend; 
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.stockID}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.exDividendDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.payoutDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.sharesHeld}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.dividendPerShare.toFixed(3)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600">${totalAmount} 元</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900" onclick="deleteDividendRecord(${index})">刪除</button>
                    </td>
                `;
                dividendTableBody.appendChild(row);
            });
        }
        
        /**
         * 刪除股息發放紀錄。
         * @param {number} index - 要刪除的紀錄在陣列中的索引。
         */
        window.deleteDividendRecord = (index) => {
            if (confirm('確定要刪除這筆股息紀錄嗎？')) {
                dividendRecords.splice(index, 1);
                localStorage.setItem(dividendKey, JSON.stringify(dividendRecords));
                updateSummary();
                showMessage('股息紀錄已刪除！');
            }
        };
        
        /**
         * 將留存的股票資訊快速填入表單。
         * @param {string} stockID - 股名/股號。
         * @param {number} dividendPerShare - 每股股利。
         */
        window.quickFillDividend = (stockID, dividendPerShare) => {
            stockIdInput.value = stockID;
            // 使用 toFixed(3) 確保小數點位數
            dividendPerShareInput.value = dividendPerShare.toFixed(3); 
            // 讓使用者知道已填入
            showMessage(`已自動填入 ${stockID} 的股號與股利 (${dividendPerShare.toFixed(3)})！`);
        };


        /**
         * 渲染已儲存的股票資訊列表 (依股名/股號排序)。
         */
        function renderStockInfoList() {
            stockInfoTableBody.innerHTML = '';
            
            // 1. 將 Map 轉換為陣列
            let stockList = Array.from(stockInfo.entries()).map(([stockID, info]) => ({
                stockID,
                ...info
            }));
            
            // 2. 依照 stockID (股號/股名) 從小到大排序
            stockList.sort((a, b) => a.stockID.localeCompare(b.stockID));

            // 3. 渲染列表
            stockList.forEach((record) => {
                const row = document.createElement('tr');
                const stockID = record.stockID;
                const dividend = record.dividendPerShare;

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${stockID}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${dividend.toFixed(3)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-left text-sm font-medium">
                        <button class="px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors duration-200" 
                                onclick="quickFillDividend('${stockID}', ${dividend})">
                            快速填寫
                        </button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-red-600 hover:text-red-900" onclick="deleteStockInfo('${stockID}')">刪除</button>
                    </td>
                `;
                stockInfoTableBody.appendChild(row);
            });
        }
        
        /**
         * 刪除留存的股票資訊。
         * @param {string} stockID - 要刪除的股名/股號。
         */
        window.deleteStockInfo = (stockID) => {
            if (confirm(`確定要刪除股票 ${stockID} 的留存資訊嗎？`)) {
                stockInfo.delete(stockID);
                localStorage.setItem(stockInfoKey, JSON.stringify(Array.from(stockInfo.entries())));
                renderStockInfoList();
                showMessage(`股票 ${stockID} 的資訊已刪除！`);
            }
        };

        /**
         * 處理股息表單提交。
         */
        dividendForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const stockID = stockIdInput.value.trim();
            const exDividendDate = document.getElementById('ex-dividend-date').value;
            const payoutDate = document.getElementById('payout-date').value;
            const sharesHeld = parseInt(document.getElementById('shares-held').value);
            const dividendPerShare = parseFloat(dividendPerShareInput.value);

            if (!stockID || !exDividendDate || !payoutDate || isNaN(sharesHeld) || sharesHeld <= 0 || isNaN(dividendPerShare) || dividendPerShare <= 0) {
                showMessage('請檢查所有股息欄位是否都已正確填寫！');
                return;
            }

            // 實作無條件捨去：Math.floor(持有股數 * 每股股利)
            const calculatedDividend = sharesHeld * dividendPerShare;
            const totalDividend = Math.floor(calculatedDividend);
            
            const newRecord = {
                id: Date.now(),
                stockID: stockID,
                exDividendDate: exDividendDate,
                payoutDate: payoutDate,
                sharesHeld: sharesHeld,
                dividendPerShare: dividendPerShare,
                totalDividend: totalDividend, // 儲存無條件捨去後的整數
            };
            
            // 1. 儲存股息發放紀錄
            dividendRecords.push(newRecord);
            localStorage.setItem(dividendKey, JSON.stringify(dividendRecords));

            // 2. 儲存股票資訊 (股名/股號 & 每股股利)
            // 將股利儲存為原始浮點數
            stockInfo.set(stockID, { dividendPerShare: dividendPerShare });
            localStorage.setItem(stockInfoKey, JSON.stringify(Array.from(stockInfo.entries())));

            // 3. 更新頁面
            updateSummary();
            dividendForm.reset(); // 清空表單
            showMessage(`股息紀錄已儲存！總金額 (無條件捨去)：${totalDividend} 元`);
        });


        // *** 初始化與定時器設定 ***

        /**
         * 頁面初始化。
         */
        function initialize() {
            createInterface();
            updateSummary(); // 第一次計算總金額
            fetchExchangeRate(); // 第一次獲取匯率

            // 設定定時器：每 10 分鐘 (10 * 60 * 1000 毫秒) 重新抓取匯率
            setInterval(fetchExchangeRate, 10 * 60 * 1000); 
        }

        initialize();

    </script>
</body>
</html>
