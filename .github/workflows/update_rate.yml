name: Update Exchange Rate

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  update-rate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and process exchange rate
        shell: bash
        run: |
          API_URL="https://api.freecurrencyapi.com/v1/latest?apikey=fca_live_example&base_currency=TWD&currencies=JPY"

          echo "Fetching rate from API..."
          RESPONSE=$(curl -s "$API_URL")

          if [ $? -ne 0 ]; then
            echo "::error::Curl failed."
            exit 1
          fi

          JPY_RATE=$(echo "$RESPONSE" | grep -o '"JPY":[0-9.]*' | cut -d: -f2)

          if [ -z "$JPY_RATE" ]; then
            echo "::error::Failed to extract JPY rate."
            echo "Response: $RESPONSE"
            exit 1
          fi

          echo "Writing latest_rate.json..."
          echo "{\"last_updated\":\"$(date -u +'%Y-%m-%d %H:%M:%S UTC')\",\"twd_to_jpy\":$JPY_RATE}" > latest_rate.json

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: latest_rate.json
          commit_message: "自動更新匯率：TWD/JPY"
