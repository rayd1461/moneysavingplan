name: Update Exchange Rate

on:
  workflow_dispatch: 
  schedule:
    - cron: "0 0 * * *"

jobs:
  update-rate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        # 確保 token 權限
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch, Process, and Create JSON
        shell: bash
        run: |
          PRIMARY_API_URL="https://api.freecurrencyapi.com/v1/latest?apikey=fca_live_example&base_currency=TWD&currencies=JPY"
          SECONDARY_API_URL="https://query1.finance.yahoo.com/v7/finance/quotes?symbols=JPYTWD=X"
          
          echo "Attempting primary API..."
          RESPONSE=$(curl -s --max-time 10 "$PRIMARY_API_URL")
          CURL_STATUS=$?
          
          if [ $CURL_STATUS -eq 0 ] && echo "$RESPONSE" | grep -q '"JPY"'; then
            echo "Primary API successful. Parsing data..."
            JPY_RATE=$(echo "$RESPONSE" | grep -o '"JPY":[0-9.]*' | cut -d: -f2)
            SOURCE="FreecurrencyAPI"
            
          else
            echo "Primary API failed or data missing. Attempting secondary API..."
            RESPONSE=$(curl -s --max-time 10 "$SECONDARY_API_URL")
            CURL_STATUS=$?

            if [ $CURL_STATUS -eq 0 ] && echo "$RESPONSE" | grep -q 'regularMarketPrice'; then
                echo "Secondary API successful. Parsing data..."
                JPYTWD_RATE=$(echo "$RESPONSE" | grep -o '"regularMarketPrice":[0-9.]*' | cut -d: -f2)
                
                if [ -n "$JPYTWD_RATE" ] && [ "$(echo "$JPYTWD_RATE > 0" | bc -l)" -eq 1 ]; then
                    JPY_RATE=$(echo "1 / $JPYTWD_RATE" | bc -l)
                    SOURCE="Yahoo Finance (Inverse)"
                else
                    echo "::error::Secondary API failed to provide valid JPY/TWD rate."
                    exit 1
                fi
            else
                echo "::error::Both APIs failed to provide data. Curl Status: $CURL_STATUS"
                exit 1
            fi
          fi

          if [ -z "$JPY_RATE" ]; then
            echo "::error::Failed to extract JPY rate."
            exit 1
          fi

          FORMATTED_RATE=$(echo "scale=5; $JPY_RATE / 1" | bc)
          
          echo "Source: $SOURCE"
          echo "TWD/JPY Rate: $FORMATTED_RATE"

          echo "Writing latest_rate.json..."
          cat <<EOF > latest_rate.json
{
  "last_updated": "$(date -u +'%Y-%m-%d %H:%M:%S UTC')",
  "twd_to_jpy": "$FORMATTED_RATE",
  "source": "$SOURCE"
}
EOF

      # 這是最後一個步驟，也是錯誤一直發生的點
      - name: Commit and Push changes
        shell: bash
        # 使用單行命令，避免所有縮排問題
        run: |
          if git diff --exit-code latest_rate.json; then echo "No change."; else git config user.name "GitHub Actions" && git config user.email "actions@github.com" && git add latest_rate.json && git commit -m "Auto Update Rate: TWD/JPY" && git push; fi
