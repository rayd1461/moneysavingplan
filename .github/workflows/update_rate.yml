name: Update Exchange Rate

on:
  workflow_dispatch:
  schedule:
    # 每天 UTC 00:00 (台灣時間早上 8:00) 執行
    - cron: "0 0 * * *"

jobs:
  update-rate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and process exchange rate
        run: |
          API_URL="https://api.freecurrencyapi.com/v1/latest?apikey=fca_live_example&base_currency=TWD&currencies=JPY"

          echo "Fetching rate from API..."
          RATE_DATA=$(curl -s "$API_URL")

          if [ $? -ne 0 ]; then
            echo "::error::Curl failed to fetch data."
            exit 1
          fi

          JPY_RATE=$(echo "$RATE_DATA" | jq -r '.data.JPY')

          if [ -z "$JPY_RATE" ] || [ "$JPY_RATE" == "null" ]; then
            echo "::error::Failed to extract JPY rate. API response might be invalid."
            echo "Response: $RATE_DATA"
            exit 1
          fi

          echo "TWD/JPY Rate: $JPY_RATE"

          cat <<EOF > latest_rate.json
{
  "last_updated": "$(date -u +'%Y-%m-%d %H:%M:%S UTC')",
  "twd_to_jpy": $JPY_RATE
}
EOF
          echo "Created latest_rate.json"

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: latest_rate.json
          commit_message: "自動更新匯率：TWD/JPY"
