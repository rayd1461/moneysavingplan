name: Update Exchange Rate

# 確保 'on:' 與 'name:' 對齊
on:
  # 允許在 Actions 頁籤手動觸發 (沒有縮排)
  workflow_dispatch: 
  # 確保 'schedule:' 與 'workflow_dispatch:' 對齊 (沒有縮排)
  schedule:
    # 確保 '- cron:' 只有兩個空格縮排
    - cron: "0 0 * * *"

# 確保 'jobs:' 與 'name:' 對齊
jobs:
  # 確保 'update-rate:' 有兩個空格縮排
  update-rate:
    # 確保 'runs-on:' 有四個空格縮排
    runs-on: ubuntu-latest

    # 確保 'steps:' 有四個空格縮排
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # 需要設定 token 權限才能提交
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch, Process, and Create JSON
        shell: bash
        run: |
          # 嘗試主 API (Freecurrencyapi)
          PRIMARY_API_URL="https://api.freecurrencyapi.com/v1/latest?apikey=fca_live_example&base_currency=TWD&currencies=JPY"
          SECONDARY_API_URL="https://query1.finance.yahoo.com/v7/finance/quotes?symbols=JPYTWD=X"
          
          echo "Attempting primary API..."
          RESPONSE=$(curl -s --max-time 10 "$PRIMARY_API_URL")
          CURL_STATUS=$?
          
          if [ $CURL_STATUS -eq 0 ] && echo "$RESPONSE" | grep -q '"JPY"'; then
            echo "Primary API successful. Parsing data..."
            JPY_RATE=$(echo "$RESPONSE" | grep -o '"JPY":[0-9.]*' | cut -d: -f2)
            SOURCE="FreecurrencyAPI"
            
          else
            echo "Primary API failed or data missing. Attempting secondary API..."
            RESPONSE=$(curl -s --max-time 10 "$SECONDARY_API_URL")
            CURL_STATUS=$?

            if [ $CURL_STATUS -eq 0 ] && echo "$RESPONSE" | grep -q 'regularMarketPrice'; then
                echo "Secondary API successful. Parsing data..."
                JPYTWD_RATE=$(echo "$RESPONSE" | grep -o '"regularMarketPrice":[0-9.]*' | cut -d: -f2)
                
                if [ -n "$JPYTWD_RATE" ] && [ "$(echo "$JPYTWD_RATE > 0" | bc -l)" -eq 1 ]; then
                    JPY_RATE=$(echo "1 / $JPYTWD_RATE" | bc -l)
                    SOURCE="Yahoo Finance (Inverse)"
                else
                    echo "::error::Secondary API failed to provide valid JPY/TWD rate."
                    exit 1
                fi
            else
                echo "::error::Both APIs failed to provide data. Curl Status: $CURL_STATUS"
                exit 1
            fi
          fi

          if [ -z "$JPY_RATE" ]; then
            echo "::error::Failed to extract JPY rate."
            exit 1
          fi

          FORMATTED_RATE=$(echo "scale=5; $JPY_RATE / 1" | bc)
          
          echo "Source: $SOURCE"
          echo "TWD/JPY Rate: $FORMATTED_RATE"

          echo "Writing latest_rate.json..."
          cat <<EOF > latest_rate.json
{
  "last_updated": "$(date -u +'%Y-%m-%d %H:%M:%S UTC')",
  "twd_to_jpy": "$FORMATTED_RATE",
  "source": "$SOURCE"
}
EOF

      - name: Commit and Push changes
        shell: bash
        run: |
          # 檢查檔案是否真的有變動
          if git diff --exit-code latest_rate.json; then
            echo "匯率沒有變動，無需提交。"
            exit 0
          fi
          
          # 設定 Git 使用者資訊
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # 將檔案加入提交
          git add latest_rate.json
          
          # 提交並推送
          git commit -m "自動更新匯率：TWD/JPY"
          git push
